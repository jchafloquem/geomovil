<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/mapa"></ion-back-button>
    </ion-buttons>
    <ion-title>{{ editKey ? 'Editar Información' : 'Registrar Datos' }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <form (ngSubmit)="saveData()" *ngIf="geojson">

    <!-- Card para datos de RENIEC -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>Datos del Productor</ion-card-title>
        <ion-card-subtitle>Fuente: RENIEC</ion-card-subtitle>
      </ion-card-header>
      <ion-card-content>
        <ion-list lines="none">
          <ion-item>
            <ion-input label="DNI" label-placement="floating" type="tel" inputmode="numeric" pattern="[0-9]*" name="dni" maxlength="8" [(ngModel)]="formData.dni" (ionChange)="searchDni()"></ion-input>
            <ion-button slot="end" fill="clear" aria-label="Buscar DNI" (click)="searchDni()" [disabled]="!formData.dni || formData.dni.length !== 8">
              <ion-icon name="search" slot="icon-only"></ion-icon>
            </ion-button>
          </ion-item>
          <ion-item>
            <ion-input label="Nombres" label-placement="floating" type="text" name="nombres" required [(ngModel)]="formData.nombres" [readonly]="true"></ion-input>
          </ion-item>
          <ion-item>
            <ion-input label="Apellido Paterno" label-placement="floating" type="text" name="apellido_paterno" required [(ngModel)]="formData.apellido_paterno" [readonly]="true"></ion-input>
          </ion-item>
          <ion-item>
            <ion-input label="Apellido Materno" label-placement="floating" type="text" name="apellido_materno" required [(ngModel)]="formData.apellido_materno" [readonly]="true"></ion-input>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <!-- Card para datos de MIDAGRI -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>Datos Agrarios</ion-card-title>
        <ion-card-subtitle>Fuente: MIDAGRI</ion-card-subtitle>
      </ion-card-header>
      <ion-card-content>
        <ion-list lines="none">
          <ion-item>
            <ion-input label="Código Autogenerado" label-placement="floating" type="text" name="txt_codigoautogenerado" [(ngModel)]="formData.txt_codigoautogenerado" [readonly]="true"></ion-input>
          </ion-item>
          <ion-item>
            <ion-input label="Fecha de Registro" label-placement="floating" type="text" name="fec_registro" [(ngModel)]="formData.fec_registro" [readonly]="true"></ion-input>
          </ion-item>
          <ion-item>
            <ion-input label="Actividad Agraria" label-placement="floating" type="text" name="txt_actagraria" [(ngModel)]="formData.txt_actagraria" [readonly]="true"></ion-input>
          </ion-item>
          <ion-item>
            <ion-input label="Superficie (ha)" label-placement="floating" type="text" name="num_superficie" [(ngModel)]="formData.num_superficie" [readonly]="true"></ion-input>
          </ion-item>
          <ion-item>
            <ion-input label="Régimen de Tenencia" label-placement="floating" type="text" name="txt_regtenencia" [(ngModel)]="formData.txt_regtenencia" [readonly]="true"></ion-input>
          </ion-item>
          <ion-item>
            <ion-input label="Sexo" label-placement="floating" type="text" name="txt_sexo" [(ngModel)]="formData.txt_sexo" [readonly]="true"></ion-input>
          </ion-item>
          <ion-item>
            <ion-input label="Departamento" label-placement="floating" type="text" name="txt_departamento" [(ngModel)]="formData.txt_departamento" [readonly]="true"></ion-input>
          </ion-item>
          <ion-item>
            <ion-input label="Provincia" label-placement="floating" type="text" name="txt_provincia" [(ngModel)]="formData.txt_provincia" [readonly]="true"></ion-input>
          </ion-item>
          <ion-item>
            <ion-input label="Distrito" label-placement="floating" type="text" name="txt_distrito" [(ngModel)]="formData.txt_distrito" [readonly]="true"></ion-input>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <!-- Card para Datos del Polígono -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>Datos Geométricos</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list lines="none">
          <ion-item *ngIf="geojson.geometry.type === 'Polygon' || geojson.geometry.type === 'MultiPolygon'">
            <ion-input label="Perímetro" label-placement="floating" type="text" name="perimetro" [(ngModel)]="formData.perimetro" [readonly]="true"></ion-input>
          </ion-item>
          <ion-item *ngIf="geojson.geometry.type.includes('LineString')">
            <ion-input label="Longitud" label-placement="floating" type="text" name="perimetro" [(ngModel)]="formData.perimetro" [readonly]="true"></ion-input>
          </ion-item>
          <ion-item *ngIf="geojson.geometry.type === 'Polygon' || geojson.geometry.type === 'MultiPolygon'">
            <ion-input label="Área" label-placement="floating" type="text" name="area" [(ngModel)]="formData.area" [readonly]="true"></ion-input>
          </ion-item>
          <ion-item>
            <ion-input [label]="geojson.geometry.type === 'Point' ? 'Altitud' : 'Altitud Promedio'" label-placement="floating" type="text" name="altitud" [(ngModel)]="formData.altitud" [readonly]="true"></ion-input>
          </ion-item>
          <ion-item>
            <ion-input [label]="geojson.geometry.type === 'Point' ? 'Coordenadas del Punto' : (geojson.geometry.type.includes('LineString') ? 'Punto Central' : 'Coordenada Centroide')" label-placement="floating" type="text" name="centroide" [(ngModel)]="formData.centroide" [readonly]="true"></ion-input>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <!-- Card para Fotos -->
    <ion-card class="photo-card">
      <ion-card-header>
        <ion-card-title>Registro Fotográfico</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <swiper-container
          *ngIf="photosForDisplay.length > 0"
          [slidesPerView]="slideOpts.slidesPerView"
          [spaceBetween]="slideOpts.spaceBetween"
          [centeredSlides]="slideOpts.centeredSlides"
        >
          <swiper-slide *ngFor="let photo of photosForDisplay; let i = index">
            <div class="slide-container">
              <ion-img [src]="photo"></ion-img>
              <ion-button fill="clear" color="danger" class="delete-photo-btn" (click)="deletePhoto(i)" aria-label="Eliminar foto">
                <ion-icon slot="icon-only" name="close-circle"></ion-icon>
              </ion-button>
            </div>
          </swiper-slide>
        </swiper-container>
        <p *ngIf="photosForDisplay.length === 0" class="ion-text-center ion-padding-top">No hay fotos añadidas.</p>
        <ion-button expand="block" class="ion-margin-top main-action-button" (click)="takePicture()" [disabled]="photosForDisplay.length >= 6">
          <ion-icon slot="start" name="camera"></ion-icon>
          Añadir Foto ({{ photosForDisplay.length }} / 6)
        </ion-button>
      </ion-card-content>
    </ion-card>

    <!-- Botón de Guardar/Actualizar -->
    <ion-button type="submit" expand="block" class="ion-margin-top main-action-button" [disabled]="!formData.nombres || formData.nombres === 'Sin datos'">
      {{ editKey ? 'Actualizar Información' : 'Guardar Registro' }}
    </ion-button>

  </form>

  <!-- Mensaje si no hay GeoJSON -->
  <div *ngIf="!geojson" class="ion-text-center ion-padding">
    <p>No se recibieron datos de la geometría.</p>
    <ion-button routerLink="/mapa">Volver al Mapa</ion-button>
  </div>
</ion-content>
